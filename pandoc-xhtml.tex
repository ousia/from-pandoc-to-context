\startxmlsetups xml:pandoc
    \xmlsetsetup{\xmldocument}
        {html|body|div|h1|h2|h3|h4|h5|h6|p|blockquote|span|em|q|b|strong|a|ul|ol|li|dl|dt|dd|hr|br|sup|sub|code}
        {xml:*}

    \xmlsetsetup{\xmldocument}
        {pre/code}
        {xml:pre:code}

    \xmlsetsetup{\xmldocument}
        {head/style}
        {}

    \xmlsetsetup{\xmldocument}
        {head/meta[@name='date']}
        {}

    \xmlsetsetup{\xmldocument}
        {head/title}
        {xml:doc:title}

    \xmlsetsetup{\xmldocument}
        {head/meta[@name='subtitle']}
        {xml:doc:subtitle}

    \xmlsetsetup{\xmldocument}
        {head/meta[@name='author']}
        {xml:doc:author}

    \xmlsetsetup{\xmldocument}
        {h2[contains(@class,'author')]}
        {xml:title:author}

    \xmlsetsetup{\xmldocument}
        {(div|span)[@lang]}
        {xml:lang}

    \xmlsetsetup{\xmldocument}
        {[contains(@class,'part')]/h1}
        {xml:part}

    \xmlsetsetup{\xmldocument}
        {[contains(@class,'part')]/[contains(@class,'level2')]/h2}
        {xml:h1}

    \xmlsetsetup{\xmldocument}
        {[contains(@class,'part')]/[contains(@class,'level2')]/[contains(@class,'level3')]/h3}
        {xml:h2}

    \xmlsetsetup{\xmldocument}
        {[contains(@class,'part')]/[contains(@class,'level2')]/[contains(@class,'level3')]/[contains(@class,'level4')]/h4}
        {xml:h3}

    \xmlsetsetup{\xmldocument}
        {[contains(@class,'part')]/[contains(@class,'level2')]/[contains(@class,'level3')]/[contains(@class,'level4')]/[contains(@class,'level5')]/h5}
        {xml:h4}

    \xmlsetsetup{\xmldocument}
        {[contains(@class,'hidden')]/h1}
        {xml:hidden}

    \xmlsetsetup{\xmldocument}
        {[@id='header']}
        {xml:titlepage}

    \xmlsetsetup{\xmldocument}
        {[@id='copyright' or contains(@class,'rights') or contains(@class,'copyright')]}
        {xml:rights}

    \xmlsetsetup{\xmldocument}
        {[@id='dedication' or contains(@class,'dedication')]}
        {xml:dedication}

    \xmlsetsetup{\xmldocument}
        {[@id='epigraph' or contains(@class,'epigraph')]}
        {xml:epigraph}

    \xmlsetsetup{\xmldocument}
        {[@id='frontmatter' or contains(@class,'frontmatter')]}
        {xml:frontmatter}

    \xmlsetsetup{\xmldocument}
        {[@id='bodymatter' or contains(@class,'bodymatter')]}
        {xml:bodymatter}

    \xmlsetsetup{\xmldocument}
        {[@id='backmatter' or contains(@class,'backmatter')]}
        {xml:backmatter}

    \xmlsetsetup{\xmldocument}
        {[@id='appendices' or contains(@class,'appendices')]}
        {xml:appendices}

    \xmlsetsetup{\xmldocument}
        {[@id='colophon' or contains(@class,'colophon')]}
        {xml:colophon}

    \xmlsetsetup{\xmldocument}
        {[@class='signature-date']}
        {xml:signaturedate}

    \xmlsetsetup{\xmldocument}
        {span[@label or contains(@class,'tex\letterpercent-logo')]}
        {xml:tex:logo}

    \xmlsetsetup{\xmldocument}
        {a[contains(@href,'\letterhat\letterhash[A-Za-z]')]}
        {xml:internal:link}

    \xmlsetsetup{\xmldocument}
        {a[@class='footnoteRef']}
        {xml:footnote:ref}

    \xmlsetsetup{\xmldocument}
        {div[@class='footnotes']}
        {}

    \xmlsetsetup{\xmldocument}
        {a[@class='uri']}
        {xml:autolink}

    \xmlsetsetup{\xmldocument}
        {a[@class='footnoteBack']}
        {}

    \xmlsetsetup{\xmldocument}
        {a[text()='â†©']}
        {}

    \xmlsetsetup{\xmldocument}
        {ol[@style='list-style-type: decimal']}
        {xml:ol}

    \xmlsetsetup{\xmldocument}
        {ol[@style='list-style-type: lower-alpha']}
        {xml:loweralphalist}

    \xmlsetsetup{\xmldocument}
        {ol[@style='list-style-type: upper-alpha']}
        {xml:upperalphalist}

    \xmlsetsetup{\xmldocument}
        {ol[@style='list-style-type: lower-roman']}
        {xml:lowerromanlist}

    \xmlsetsetup{\xmldocument}
        {ol[@style='list-style-type: upper-roman']}
        {xml:upperromanlist}

    \xmlsetsetup{\xmldocument}
        {ol[@style='list-style-type: lower-greek']}
        {xml:lowergreeklist}

    \xmlsetsetup{\xmldocument}
        {div[contains(@class,'options')]/dl/dt}
        {xml:dt_options}

    \xmlsetsetup{\xmldocument}
        {div[contains(@class,'options')]/dl/dl}
        {xml:dl_options}
\stopxmlsetups

\xmlregistersetup{xml:pandoc}

\startxmlsetups xml:html
    \mainlanguage[\xmlatt{#1}{lang}]
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:body
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:doc:title
    \setupinteraction[title={\xmlflush{#1}}]
\stopxmlsetups

\startxmlsetups xml:doc:subtitle
    \setupinteraction[subtitle={\xmlatt{#1}{content}}]
\stopxmlsetups

\startxmlsetups xml:title:author
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:titlepage
    \setupinteraction
        [author={\xmlconcat{#1}{/h2[contains(@class,'author')]}{, }}]
    \startcoverpagemakeup
        \setupbodyfont[svb]
        {\setupbodyfont[25pt]\sc \xmlconcat{#1}{/h2[contains(@class,'author')]}{\\}}
        \vfill
        \scale[width=\textwidth]{\bf \xmltext{#1}{h1[@class='title']}}

        \blank[small]\startalign [flushright]
        \dontleavehmode\scale[width=.75\textwidth]{\it \xmltext{#1}{h1[@class='subtitle']}}
        \stopalign
        \vfill
        \startalign[center]
        \dontleavehmode\CoverImage
        \stopalign
        \vfill
        \startalign[flushright]
        \dontleavehmode\scale[width=.75\textwidth]{\xmltext{#1}{p[@class='publisher']}}
        \stopalign
    \stopcoverpagemakeup

    \starttitlepagemakeup
        \mbox{}\vfill

        {\itd\xmltext{#1}{h1[@class='title']}\par}\blank[big]
        {\resetbreakpoints\itb\setupinterlinespace \xmltext{#1}{h1[@class='subtitle']}\par}\blank[3*big]
        {\sc \xmlconcat{#1}{/h2[contains(@class,'author')]}{\\}}

        \vfill
        \xmltext{#1}{h3[@class='date']}
        \vfill
        \xmltext{#1}{p[@class='publisher']}
    \stoptitlepagemakeup
\stopxmlsetups

\startxmlsetups xml:rights
    \startcopyrightmakeup
    \xmlflush{#1}
    \stopcopyrightmakeup
\stopxmlsetups

\startxmlsetups xml:dedication
    \startdedicationmakeup
    \xmlflush{#1}
    \stopdedicationmakeup
\stopxmlsetups

\startxmlsetups xml:epigraph
    \startepigraphmakeup
    \xmlflush{#1}
    \stopepigraphmakeup
\stopxmlsetups

\startxmlsetups xml:frontmatter
    \def\TOC_Title{\startmode[*en]\title{Contents}\stopmode\startmode[*es]\title{Sumario}\stopmode\startmode[*deo]\title{Inhalt}\stopmode\startmode[*de]\title{Inhalt}\stopmode}
    \startfirstmatter
    \TOC_Title\placelist[part,chapter]
    \stopfirstmatter

    \startfrontmatter
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:bodymatter
    \stopfrontmatter

    \startbodymatter
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:backmatter
    \startbackmatter
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:appendices
    \startappendices
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:colophon
    \startbackmatter
    \startnotmode[nofootnotes]
    \def\Footnotes_Title{\startmode[*en]\chapter{Notes}\stopmode\startmode[*es]\chapter{Notas}\stopmode\startmode[*deo]\chapter{Notizen}\stopmode\startmode[*de]\chapter{Notizen}\stopmode\startmode[*fr]\chapter{Notes}\stopmode}
    \Footnotes_Title\placefootnotes
    \stopnotmode

    \startcolophonmakeup
    \xmlflush{#1}
    \stopcolophonmakeup
    \stopbackmatter
\stopxmlsetups

\startxmlsetups xml:div
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:lang
     \begingroup
         \language[\xmlatt{#1}{lang}]
         \xmlsetup{#1}{xml:\xmltag{#1}}
     \endgroup
\stopxmlsetups

\startxmlsetups xml:part
    \part[\xmlattribute{#1}{..//div}{id}]{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h1
    %~ \startchapter[bookmark={\xmltext{\xmldocument}{../h1}}, title={\xmlflush{#1}}]\stopchapter
    \chapter[\xmlattribute{#1}{..//div}{id}]{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h2
    \section[\xmlattribute{#1}{..//div}{id}]{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h3
    \subsection[\xmlattribute{#1}{..//div}{id}]{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h4
    \subsubsection[\xmlattribute{#1}{..//div}{id}]{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h5
    \subsubsubsection[\xmlattribute{#1}{..//div}{id}]{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:h6
    \subsubsubsubsection[\xmlattribute{#1}{..//div}{id}]{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:p
    \xmldoifnotselfempty {#1} {
        \dontleavehmode
        \ignorespaces
        \xmlflush{#1}
        \removeunwantedspaces
    }
    \par
\stopxmlsetups

\startxmlsetups xml:blockquote
    %~ check both modes for mainlanguage and language \doifmodeelse{*en}{\blank\startnarrow\setupindenting[yes,next]\xmlflush{#1}\stopnarrow\blank}    {\blank\startnarrow\xmlflush{#1}\stopnarrow\blank}
    \blank\startnarrow\xmlflush{#1}\stopnarrow\blank
\stopxmlsetups

\startxmlsetups xml:signaturedate
    \startalign[flushright]
    \xmlflush{#1}
    \stopalign
\stopxmlsetups

\startxmlsetups xml:span
   \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:em
    \begingroup\em\xmlflush{#1}\endgroup
\stopxmlsetups

\startxmlsetups xml:q
    \quotation{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:b
    \begingroup\bf\xmlflush{#1}\endgroup
\stopxmlsetups

\startxmlsetups xml:pre:code
    \begingroup\setupinterlinespace[line=2.8ex]\xmlprettyprint{#1}{none}\endgroup
\stopxmlsetups

\startxmlsetups xml:code % need extra code to work
    \begingroup\sethyphenationfeatures[underscore]\tt\xmlflushspacewise{#1}\endgroup
\stopxmlsetups

\startxmlsetups xml:strong % used for sans-serif instead of bold
    \doifmodeelse{strong:ssandnotbf}
    {\begingroup\ss\xmlflush{#1}\endgroup}
    {\begingroup\bf\xmlflush{#1}\endgroup}
\stopxmlsetups

\startxmlsetups xml:a
    \href{\xmlatt{#1}{href}}{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:internal:link
    {\em\doiftext{\in[\xmlrefatt{#1}{href}]}{\in[\xmlrefatt{#1}{href}]. }\about[\xmlrefatt{#1}{href}]}
\stopxmlsetups

\startxmlsetups xml:autolink
    \url{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:footnote:set
     \startfootnote
         \xmlflush{#1}
     \stopfootnote
\stopxmlsetups

\startluacode
     local gsub = string.gsub
     function xml.expressions.idstring(str)
         return type(str) == "string" and gsub(str,"^#","") or ""
     end
\stopluacode

\startnotmode[nofootnotes]
\startxmlsetups xml:footnote:ref
    \xmlfilter{main}{div[@class='footnotes']/ol/li[@id=idstring('\xmlatt{#1}{href}')]/command(xml:footnote:set)}
\stopxmlsetups
\stopnotmode


\startxmlsetups xml:ol
    \xmldoifelse{#1}{/li/p}{
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[n][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[n]
                \xmlflush{#1}
            \stopitemize}
        } {
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[n,packed][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[n,packed]
                \xmlflush{#1}
            \stopitemize}
    }
\stopxmlsetups

\startxmlsetups xml:loweralphalist
    \xmldoifelse{#1}{/li/p}{
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[a][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[a]
                \xmlflush{#1}
            \stopitemize}
        } {
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[a,packed][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[a,packed]
                \xmlflush{#1}
            \stopitemize}
    }
\stopxmlsetups

\startxmlsetups xml:upperalphalist
    \xmldoifelse{#1}{/li/p}{
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[A][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[A]
                \xmlflush{#1}
            \stopitemize}
        } {
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[A,packed][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[A,packed]
                \xmlflush{#1}
            \stopitemize}
    }
\stopxmlsetups

\startxmlsetups xml:lowerromanlist
    \xmldoifelse{#1}{/li/p}{
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[r][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[r]
                \xmlflush{#1}
            \stopitemize}
        } {
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[r,packed][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[r,packed]
                \xmlflush{#1}
            \stopitemize}
    }
\stopxmlsetups

\startxmlsetups xml:upperromanlist
    \xmldoifelse{#1}{/li/p}{
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[R][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[R]
                \xmlflush{#1}
            \stopitemize}
        } {
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[R,packed][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[R,packed]
                \xmlflush{#1}
            \stopitemize}
    }
\stopxmlsetups

\startxmlsetups xml:lowergreeklist % not implemented by pandoc
    \xmldoifelse{#1}{/li/p}{
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[g][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[g]
                \xmlflush{#1}
            \stopitemize}
        } {
        \doifnumberelse{\xmlatt{#1}{start}}{
            \startitemize[g,packed][start=\xmlatt{#1}{start}]
                \xmlflush{#1}
            \stopitemize
            } {
            \startitemize[g,packed]
                \xmlflush{#1}
            \stopitemize}
    }
\stopxmlsetups

\startxmlsetups xml:ul
     \xmldoifelse{#1}{/li/p}{
         \startitemize
             \xmlflush{#1}
         \stopitemize
     } {
         \startitemize[packed]
             \xmlflush{#1}
         \stopitemize
     }
\stopxmlsetups


\startxmlsetups xml:li
    \startitem
        \xmlflush{#1}
    \stopitem
\stopxmlsetups

\startxmlsetups xml:dl
    \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:dt
    \startdescription{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:dd
    \xmlflush{#1}
    \stopdescription
\stopxmlsetups

\startxmlsetups xml:dt_options
    \startoptions{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:dd_options
    \xmlflush{#1}
    \stopoptions
\stopxmlsetups

\startxmlsetups xml:hr
    \blank\hrule\blank
\stopxmlsetups

\startxmlsetups xml:br
     \\
\stopxmlsetups

\startxmlsetups xml:sup
     \high{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups xml:sub
     \low{\xmlflush{#1}}
\stopxmlsetups

%%% this element is the way to get the TeX and ConTeXt logos
%%% markdown tagging:
%%% <span label="tex">TeX</span>
%%% Sp you get standard text in other formats and logos with ConTeXt

\startxmlsetups xml:logo
    \executeifdefined{\utfupper{\xmlatt{#1}{label}}}{{\tttf ???}}
\stopxmlsetups

%%% alternate TeX logos
%%% <span class="tex-logo">TeX</span>

\startxmlsetups xml:tex:logo
    \executeifdefined{\utfupper{\xmlflush{#1}}}{{\tttf ???}}
\stopxmlsetups

%%% This is a way of having a cover image
%%% But you might want to have a new cover.
%%% Default image from (edited by me):
%%% https://openclipart.org/detail/216016/
%%% TypographyTribute can be found at:
%%% http://www.dafont.com/typographytribute.font

\def\CoverImageFile{}%\externalfigure[TypeWriter][width=\textwidth]}
\definefontfamily[ornamenta][rm][TypographyTribute]
\def\CoverImageFont{\scale[width=\textwidth]{\ornamenta F}}
\def\CoverImage{\doifsomethingelse{\CoverImageFile}{\CoverImageFile}{\CoverImageFont}}

%%% This a simple method to have interactive hyperlinks

\def\url#1{\begingroup\tt\goto{\hyphenatedurl{#1}}[url(#1)]\endgroup}
\def\href#1#2{\goto{#2} [url(#1)]}

%%% Two samples for definition lists

\definedescription[description][hang=fit, width=fit, headstyle=em, align=justify, margin=yes]
\definedescription[options][width=fit, headstyle=tt, align=justify, location=left, margin=yes]

%%% These makeups are created (defined) to avoid crashes with
%%% the current setup. They need to be configured (setup)
%%% when if we want to use them (otherwise we get only defaults).

\definemakeup[coverpage]
\definemakeup[titlepage]
\definemakeup[copyright]
\definemakeup[dedication]
\definemakeup[epigraph]
\definemakeup[colophon]

%%% These are language synonyms, so that XML values can match
%%% ConTeXt values (btw, ConTeXt seems to have less languages
%%% than LaTeX)

\installlanguage [af-ZA] [af]
\installlanguage [ar-DZ] [ar-dz]
\installlanguage [ar-IQ] [ar-iq]
\installlanguage [ar-JO] [ar-jo]
\installlanguage [ar-LB] [ar-lb]
\installlanguage [ar-MA] [ar-ma]
\installlanguage [ar-SY] [ar-sy]
\installlanguage [bg-BG] [bg]
\installlanguage [ca-ES] [ca]
\installlanguage [cy-UK] [cy]
\installlanguage [cz-CZ] [cz]
\installlanguage [da-DK] [da]
\installlanguage [de-1901] [deo]
\installlanguage [de-AT] [de-at]
\installlanguage [de-CH] [de-ch]
\installlanguage [de-DE] [de-de]
\installlanguage [el] [gr]
\installlanguage [en-UK] [uk]
\installlanguage [en-US] [en]
\installlanguage [es-ES] [es]
\installlanguage [et-EE] [et]
\installlanguage [eu-ES] [eu]
\installlanguage [fi-FI] [fi]
\installlanguage [fr-CA] [fr]
\installlanguage [fr-FR] [fr]
\installlanguage [grc] [agr]
\installlanguage [he] [il]
\installlanguage [he-IL] [il]
\installlanguage [hr-HR] [hr]
\installlanguage [hu-HU] [hu]
\installlanguage [is-IS] [is]
\installlanguage [it-IT] [it]
\installlanguage [jp] [ja]
\installlanguage [jp-JP] [ja]
\installlanguage [nb-NO] [nb]
\installlanguage [nl-NL] [nl]
\installlanguage [nn-NO] [nn]
\installlanguage [no-NO] [no]
\installlanguage [pl-PL] [pl]
\installlanguage [pt-BR] [pt]
\installlanguage [pt-PT] [pt]
\installlanguage [ro-RO] [ro]
\installlanguage [ru-RU] [ru]
\installlanguage [sk-SK] [sk]
\installlanguage [sl-SL] [sl]
\installlanguage [sv-SE] [sv]
\installlanguage [tr-TR] [tr]
\installlanguage [uk] [ua]
\installlanguage [uk-UA] [ua]
\installlanguage [vi] [vn]
\installlanguage [vi-VN] [vn]
